<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tripline ‚Äî Touch Prototype</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    :root{
      --bg:#0b0c10; --panel:#0f1420; --text:#e8e8e8; --muted:#9aa3b2; --acc:#6ee7b7; --border:#202335; --danger:#ff6b6b;
      --btn:#1b2133; --btnBorder:#2a2f45;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}

    /* App shell: fixed viewport, NO SCROLL anywhere */
    #app{height:100vh; display:grid; grid-template-rows:56px 1fr 56px; overflow:hidden}

    header, footer{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; border-color:var(--border); background:#0b0f16;
    }
    header{border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border); color:var(--muted); font-size:14px}

    .brand{font-weight:600}
    .pill{border:1px solid var(--border); background:#0b0f16; padding:6px 10px; border-radius:999px; color:#cbd5e1; font-size:12px}
    .muted{color:var(--muted)}
    .btn{
      background:var(--btn); border:1px solid var(--btnBorder); color:#fff; border-radius:14px; padding:12px 16px; cursor:pointer;
      font-size:16px; min-width:64px; text-align:center; user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.brand{background:linear-gradient(135deg,#22c55e,#06b6d4); border:0}
    .btn.danger{background:var(--danger); border:0}
    .btn.ghost{background:transparent}
    .row{display:flex; gap:10px; align-items:center}

    /* Views */
    main{position:relative; overflow:hidden}
    .view{position:absolute; inset:0; display:none}
    .view.active{display:block}

    /* Login view */
    #loginView{display:grid; place-items:center}
    .panel{
      width:min(560px,94vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px;
    }
    .field{display:grid; gap:8px; margin:10px 0}
    .input{
      background:#0a0e17; border:1px solid #25304a; border-radius:12px; padding:14px 12px; color:#e8e8e8; font-size:16px;
    }
    .flash{margin-top:8px; color:#ffb4b4; min-height:20px}

    /* Feed view (single card + nav buttons; no scrolling) */
    #feedView{display:grid; grid-template-rows:1fr auto; padding:12px}
    .card{
      height:100%; display:grid; grid-template-rows:auto auto 1fr auto; gap:10px;
      background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; overflow:hidden;
    }
    .cover{width:100%; height:42vh; max-height:360px; object-fit:cover; border-radius:12px; border:1px solid #25304a}
    .meta{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .title{font-size:18px; font-weight:600}
    .subtitle{font-size:14px; color:var(--muted)}
    .sum{font-size:14px; color:#d6d6d6; background:#0a0e17; border:1px solid #25304a; border-radius:12px; padding:10px; height:9vh; overflow:hidden}
    .pager{display:flex; justify-content:space-between; gap:10px}
    .dots{display:flex; align-items:center; gap:8px; justify-content:center}
    .dot{width:8px; height:8px; border-radius:50%; background:#2a2f45}
    .dot.active{background:#6ee7b7}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .heart{display:flex; align-items:center; gap:8px; background:#0b0f16; border:1px solid var(--border); padding:10px 12px; border-radius:12px; min-width:120px; justify-content:center}
    .heart.liked{background:#112315; border-color:#2e7d32}

    /* Journey detail (static height blocks, no scroll) */
    #journeyView{display:grid; grid-template-rows:auto 1fr auto; padding:12px}
    .j-head{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; display:grid; gap:8px}
    .j-cover{width:100%; height:26vh; max-height:220px; object-fit:cover; border-radius:12px; border:1px solid #25304a}
    .j-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px; height:100%; overflow:hidden}
    .j-map{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px; display:grid; grid-template-rows:auto 1fr}
    .map{height:100%; border-radius:10px; border:1px solid #25304a; overflow:hidden}
    .j-photos{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px; display:grid; grid-template-rows:auto 1fr}
    .grid4{display:grid; grid-template-columns:repeat(2, 1fr); grid-auto-rows:1fr; gap:8px}
    .thumb{width:100%; height:100%; object-fit:cover; border-radius:10px; border:1px solid #25304a}

    .j-footer{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="row">
        <span class="brand">Tripline</span>
        <span id="globalLikes" class="pill" style="display:none"></span>
      </div>
      <div class="row">
        <span class="pill">signed in: <span id="who"></span></span>
        <button id="logoutBtn" class="btn">Log out</button>
      </div>
    </header>

    <main>
      <!-- LOGIN -->
      <section id="loginView" class="view active">
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <div class="brand">Sign in</div>
            <div class="muted" style="font-size:12px">demo: alice/bob/charlie ‚Ä¢ pass</div>
          </div>
          <div class="field">
            <label class="muted">Username</label>
            <input id="u" class="input" placeholder="alice">
          </div>
          <div class="field">
            <label class="muted">Password</label>
            <input id="p" class="input" type="password" placeholder="pass">
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:8px">
            <button id="loginBtn" class="btn brand">Sign in</button>
          </div>
          <div id="loginFlash" class="flash"></div>
        </div>
      </section>

      <!-- FEED (one post per screen, navigate with buttons only) -->
      <section id="feedView" class="view">
        <div class="card">
          <img id="feedCover" class="cover" src="" alt="">
          <div class="meta">
            <div>
              <div id="feedTitle" class="title"></div>
              <div id="feedSub" class="subtitle"></div>
            </div>
            <span id="feedBadge" class="pill"></span>
          </div>
          <div id="feedSummary" class="sum"></div>

          <div class="toolbar" style="margin-top:2px">
            <button id="likeBtn" class="btn heart"><span id="likeIcon">ü§ç</span> <span id="likeCount">0</span></button>
            <button id="openBtn" class="btn brand">Open Journey</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px; justify-content:space-between">
          <button id="prevPost" class="btn">‚óÄ Prev</button>
          <div id="feedDots" class="dots"></div>
          <button id="nextPost" class="btn">Next ‚ñ∂</button>
        </div>
      </section>

      <!-- JOURNEY DETAIL (no scroll: day switch via buttons) -->
      <section id="journeyView" class="view">
        <div class="j-head">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div>
              <div id="jTitle" class="title"></div>
              <div id="jSub" class="subtitle"></div>
            </div>
            <span id="jBadge" class="pill"></span>
          </div>
          <img id="jCover" class="j-cover" src="" alt="">
        </div>

        <div class="j-grid" style="margin:12px 0">
          <div class="j-map">
            <div class="row" style="justify-content:space-between">
              <span class="muted">Map</span>
              <span id="dayLabel" class="pill">Day 1/1</span>
            </div>
            <div id="map" class="map" aria-label="journey map"></div>
          </div>
          <div class="j-photos">
            <div class="row" style="justify-content:space-between">
              <span class="muted">Photos</span>
              <span class="muted" id="photoCount"></span>
            </div>
            <div id="gallery" class="grid4"></div>
          </div>
        </div>

        <div class="j-footer">
          <button id="prevDay" class="btn">‚óÄ Prev Day</button>
          <button id="likeBtnDetail" class="btn heart"><span id="likeIconDetail">ü§ç</span> <span id="likeCountDetail">0</span></button>
          <button id="nextDay" class="btn">Next Day ‚ñ∂</button>
          <button id="backToFeed" class="btn">Back to Feed</button>
        </div>
      </section>
    </main>

    <footer>
      <span class="muted">Touch mode: buttons only, no scrolling</span>
      <span id="footMsg" class="muted"></span>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ---------- DOM helpers ----------
    const $ = (sel, root=document)=> root.querySelector(sel);
    const $$ = (sel, root=document)=> [...root.querySelectorAll(sel)];
    async function jfetch(url, opts={}) {
      const res = await fetch(url, { credentials:"include", headers:{ "Content-Type":"application/json" }, ...opts });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function show(viewId){
      $$(".view").forEach(v => v.classList.remove("active"));
      $("#"+viewId).classList.add("active");
    }
    function setGlobalLikes(n){
      const el = $("#globalLikes");
      if(typeof n === "number"){ el.style.display="inline-block"; el.textContent = `total likes: ${n}`; }
      else el.style.display="none";
    }
    function msg(text){ $("#footMsg").textContent = text||""; setTimeout(()=>$("#footMsg").textContent="", 1500); }

    // ---------- App state ----------
    let me = null;
    let feed = [];
    let idx = 0;

    // Journey detail state
    let currentPost = null;
    let dayIdx = 0;
    let mapObj = null;

    function destroyMap(){ if(mapObj){ try{ mapObj.remove(); }catch{} mapObj = null; } }
    function initMap(el, waypoints){
      destroyMap();
      const pts = waypoints || [];
      const center = pts.length ? [pts[0].lat, pts[0].lng] : [0,0];
      mapObj = L.map(el, { scrollWheelZoom:false, zoomControl:true }).setView(center, pts.length?14:1);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(mapObj);
      const latlngs = [];
      pts.forEach(w=>{
        const m = L.marker([w.lat,w.lng]).addTo(mapObj);
        m.bindPopup(`<strong>${w.name}</strong><br/><span style="color:#9aa3b2">${w.note_time||""}</span><br/>${w.comment||""}`);
        latlngs.push([w.lat,w.lng]);
      });
      if(latlngs.length>1){ L.polyline(latlngs,{weight:3}).addTo(mapObj); mapObj.fitBounds(latlngs,{padding:[18,18]}); }
      setTimeout(()=> mapObj.invalidateSize(), 50);
    }

    // ---------- Login ----------
    async function doLogin(){
      const username = $("#u").value.trim().toLowerCase();
      const password = $("#p").value;
      $("#loginFlash").textContent = "";
      try{
        await jfetch("/api/login",{method:"POST", body: JSON.stringify({username,password})});
        await boot();
      }catch(err){
        let message = "Invalid credentials.";
        try{ const j = JSON.parse(err.message); if(j && j.error) message = j.error; }catch(e){ if(err && err.message) message = err.message; }
        $("#loginFlash").textContent = message;
      }
    }
    $("#loginBtn").addEventListener("click", doLogin);
    $("#logoutBtn").addEventListener("click", async ()=>{ try{ await jfetch("/api/logout",{method:"POST"}); location.reload(); }catch{} });

    // ---------- Feed ----------
    function renderFeedCard(){
      if(!feed.length){ msg("no posts"); return; }
      const j = feed[idx];
      $("#feedCover").src = j.cover_img; $("#feedCover").alt = j.title;
      $("#feedTitle").textContent = j.title;
      $("#feedSub").textContent = `by ${j.author_name} ‚Ä¢ ${j.date_range}`;
      $("#feedBadge").textContent = `${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?'day':'days'}`;
      $("#feedSummary").textContent = j.summary || "";

      // like UI
      $("#likeIcon").textContent = j.liked_by_me ? "‚ù§Ô∏è" : "ü§ç";
      $("#likeCount").textContent = j.like_count || 0;
      $("#likeBtn").classList.toggle("liked", !!j.liked_by_me);

      // dots
      const dots = feed.map((_,i)=>`<span class="dot ${i===idx?'active':''}"></span>`).join("");
      $("#feedDots").innerHTML = dots;
    }

    $("#prevPost").addEventListener("click", ()=>{
      if(!feed.length) return;
      idx = (idx - 1 + feed.length) % feed.length;
      renderFeedCard();
    });
    $("#nextPost").addEventListener("click", ()=>{
      if(!feed.length) return;
      idx = (idx + 1) % feed.length;
      renderFeedCard();
    });

    $("#likeBtn").addEventListener("click", async ()=>{
      if(!feed.length) return;
      const j = feed[idx];
      const wantLike = !j.liked_by_me;
      try{
        const r = await jfetch("/api/like",{method:"POST", body: JSON.stringify({ post_id: j.id, action: wantLike?"like":"unlike" })});
        // update local state
        j.liked_by_me = r.liked_by_me;
        j.like_count = r.like_count;
        setGlobalLikes(r.global_like_count);
        renderFeedCard();
        msg(wantLike ? "Liked" : "Unliked");
      }catch{ msg("Like failed"); }
    });

    $("#openBtn").addEventListener("click", async ()=>{
      if(!feed.length) return;
      await openJourney(feed[idx].id);
    });

    // ---------- Journey detail ----------
    async function openJourney(id){
      try{
        const full = await jfetch(`/api/journey?id=${encodeURIComponent(id)}`);
        currentPost = full; dayIdx = 0;
        renderJourney();
        show("journeyView");
        msg("Journey opened");
      }catch{ msg("Failed to load journey"); }
    }

    function renderJourney(){
      const j = currentPost; if(!j) return;
      $("#jTitle").textContent = j.title;
      $("#jSub").textContent = `by ${j.author_name} ‚Ä¢ ${j.date_range}`;
      $("#jBadge").textContent = `${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?'day':'days'}`;
      $("#jCover").src = j.cover_img; $("#jCover").alt = j.title;

      // like UI
      $("#likeIconDetail").textContent = j.liked_by_me ? "‚ù§Ô∏è" : "ü§ç";
      $("#likeCountDetail").textContent = j.like_count || 0;
      $("#likeBtnDetail").classList.toggle("liked", !!j.liked_by_me);

      // day
      const days = j.days || []; const N = Math.max(days.length, 1);
      dayIdx = Math.max(0, Math.min(dayIdx, N-1));
      $("#dayLabel").textContent = `Day ${dayIdx+1}/${N}`;

      const day = days[dayIdx] || { title:"", date:"", waypoints:[] };

      // photos (max 4; no scroll)
      const thumbs = (day.waypoints||[]).slice(0,4).map(w=>`<img class="thumb" src="${w.photo}" alt="${w.name}">`).join("") || `<div class="muted">no photos</div>`;
      $("#gallery").innerHTML = thumbs;
      $("#photoCount").textContent = `${(day.waypoints||[]).length} photo${(day.waypoints||[]).length===1?"":"s"}`;

      // map
      initMap($("#map"), day.waypoints||[]);
    }

    $("#prevDay").addEventListener("click", ()=>{
      if(!currentPost) return;
      const N = Math.max((currentPost.days||[]).length,1);
      dayIdx = (dayIdx - 1 + N) % N;
      renderJourney();
    });
    $("#nextDay").addEventListener("click", ()=>{
      if(!currentPost) return;
      const N = Math.max((currentPost.days||[]).length,1);
      dayIdx = (dayIdx + 1) % N;
      renderJourney();
    });
    $("#backToFeed").addEventListener("click", ()=>{
      destroyMap();
      show("feedView");
    });

    $("#likeBtnDetail").addEventListener("click", async ()=>{
      if(!currentPost) return;
      const wantLike = !currentPost.liked_by_me;
      try{
        const r = await jfetch("/api/like",{method:"POST", body: JSON.stringify({ post_id: currentPost.id, action: wantLike?"like":"unlike" })});
        currentPost.liked_by_me = r.liked_by_me;
        currentPost.like_count = r.like_count;
        // Reflect in feed cache if present
        const slot = feed.find(x=>x.id===currentPost.id);
        if(slot){ slot.liked_by_me = r.liked_by_me; slot.like_count = r.like_count; }
        setGlobalLikes(r.global_like_count);
        renderJourney();
        msg(wantLike ? "Liked" : "Unliked");
      }catch{ msg("Like failed"); }
    });

    // ---------- Boot ----------
    async function boot(){
      const who = await jfetch("/api/whoami").catch(()=>null);
      if(!who){
        show("loginView");
        $("#who").textContent = "";
        setGlobalLikes(null);
        return;
      }
      me = who; $("#who").textContent = me.name || me.username || "";
      const data = await jfetch("/api/feed");
      feed = data.items || [];
      setGlobalLikes(data.global_like_count);
      show("feedView");
      idx = 0;
      renderFeedCard();
    }

    boot();
  </script>
</body>
</html>

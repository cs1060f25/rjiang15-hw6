<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tripline ‚Äî Map Prototype</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    :root{
      --bg:#0b0c10; --panel:#0f1420; --text:#e8e8e8; --muted:#9aa3b2; --acc:#6ee7b7; --border:#202335; --btn:#1b2133; --btnB:#2a2f45;
      --ok:#2e7d32; --warn:#f7b733; --danger:#ff6b6b;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Shell */
    #app{height:100vh; display:grid; grid-template-rows:56px 1fr}
    header{
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px;
      background:#0b0f16; border-bottom:1px solid var(--border)
    }
    .brand{font-weight:600}
    .pill{border:1px solid var(--border); background:#0b0f16; padding:6px 10px; border-radius:999px; color:#cbd5e1; font-size:12px}
    .muted{color:var(--muted)}
    .btn{background:var(--btn); border:1px solid var(--btnB); color:#fff; border-radius:12px; padding:8px 10px; font-size:14px; cursor:pointer}
    .btn.brand{background:linear-gradient(135deg,#22c55e,#06b6d4); border:0}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 8px; font-size:12px; border-radius:10px}

    /* Main split: full map + sidebar */
    .main{display:grid; grid-template-columns:1fr min(380px,32vw); min-height:0}
    #map{height:calc(100vh - 56px); width:100%}
    aside{border-left:1px solid var(--border); background:#0f1420; min-height:0; display:grid; grid-template-rows:auto 1fr auto}

    .side-top{padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .side-top .row{display:flex; gap:8px; align-items:center}
    .side-list{overflow:auto; padding:10px; border-top:1px solid var(--border); border-bottom:1px solid var(--border)}
    .item{background:#0b0f16; border:1px solid var(--border); border-radius:12px; padding:10px; display:grid; gap:8px; margin-bottom:10px}
    .meta{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .title{font-weight:600}
    .subtitle{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .chip{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--border); background:#0b0f16; padding:4px 8px; border-radius:999px; font-size:12px}
    .heart{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--border); background:#0b0f16; padding:6px 8px; border-radius:10px; cursor:pointer}
    .heart.liked{background:#112315; border-color:#295a2f}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block}

    .gallery{display:grid; grid-template-columns:repeat(4,1fr); gap:6px}
    .thumb{width:100%; height:56px; object-fit:cover; border-radius:8px; border:1px solid #25304a}

    .side-bottom{padding:10px; display:flex; gap:8px; justify-content:space-between; align-items:center}
    .hint{color:var(--muted); font-size:12px}

    /* Login overlay */
    #login{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.5)}
    .panel{width:min(560px,94vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px}
    .field{display:grid; gap:8px; margin:10px 0}
    .input{background:#0a0e17; border:1px solid #25304a; border-radius:12px; padding:12px; color:#e8e8e8; font-size:16px}
    .flash{margin-top:8px; color:#ffb4b4; min-height:20px}
    button[data-like-popup] { color: #fff !important; }
    .heart .likeCount,
    .heart [data-like-count],
    #likeCount,
    #likeCountDetail {
    color: #fff !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="row">
        <span class="brand">Tripline</span>
        <span id="globalLikes" class="pill" style="display:none"></span>
      </div>
      <div class="row">
        <span class="pill">signed in: <span id="who"></span></span>
        <button id="logoutBtn" class="btn">Log out</button>
      </div>
    </header>

    <section class="main">
      <div id="map" aria-label="All journeys map"></div>

      <aside>
        <div class="side-top">
          <div class="row">
            <span class="muted">Visibility:</span>
            <button id="btnShowAll" class="btn small">Show all</button>
            <button id="btnHideAll" class="btn small">Hide all</button>
          </div>
          <div class="row">
            <span class="muted">Focus:</span>
            <button id="btnFitAll" class="btn small">Fit all</button>
          </div>
        </div>

        <div id="list" class="side-list">
          <!-- journey items injected here -->
        </div>

        <div class="side-bottom">
          <span class="hint">Tip: click a marker or a polyline to preview; use buttons to like/focus.</span>
          <span class="pill" id="status"></span>
        </div>
      </aside>
    </section>
  </div>

  <!-- Login modal -->
  <div id="login" style="display:none">
    <div class="panel">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="brand">Sign in</div>
        <div class="muted" style="font-size:12px">demo: alice/bob/charlie ‚Ä¢ pass</div>
      </div>
      <div class="field">
        <label class="muted">Username</label>
        <input id="u" class="input" placeholder="alice" autofocus>
      </div>
      <div class="field">
        <label class="muted">Password</label>
        <input id="p" class="input" type="password" placeholder="pass">
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button id="loginBtn" class="btn brand">Sign in</button>
      </div>
      <div id="loginFlash" class="flash"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ---------- helpers ----------
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
    async function jfetch(url, opts={}) {
      const res = await fetch(url, { credentials:"include", headers:{ "Content-Type":"application/json" }, ...opts });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function setGlobalLikes(n){
      const el = $("#globalLikes");
      if(typeof n === "number"){ el.style.display="inline-block"; el.textContent = `total likes: ${n}`; }
      else el.style.display="none";
    }
    function say(text){ const s=$("#status"); s.textContent=text||""; setTimeout(()=>{ if(s.textContent===text) s.textContent=""; }, 1500); }

    // ---------- app state ----------
    let me=null, feed=[], map=null;
    const palette = ["#6ee7b7","#93c5fd","#fca5a5","#f9a8d4","#fde68a","#a5b4fc","#7dd3fc","#86efac","#fca5ff","#fcd34d"];

    // each journey => { layer: L.LayerGroup, markers:[L.Marker], line:L.Polyline, visible:true }
    const layersById = new Map();

    // ---------- marker/icon helpers ----------
    function markerIcon(color, label){
      const html = `
        <div style="
          background:${color}; color:#000; font-weight:700; border-radius:12px; padding:4px 8px;
          box-shadow:0 1px 0 rgba(0,0,0,.4); border:2px solid rgba(0,0,0,.25);">
          ${label||""}
        </div>`;
      return L.divIcon({ html, className:"", iconSize:[24,24], iconAnchor:[12,12] });
    }

    function buildJourneyLayer(j, color){
      const g = L.layerGroup();
      const markers=[];
      const latlngs=[];
      (j.days||[]).forEach((d,di)=>{
        (d.waypoints||[]).forEach((w,wi)=>{
          const ll = [w.lat, w.lng];
          latlngs.push(ll);
          const m = L.marker(ll, { icon: markerIcon(color, String(wi+1)) });
          const html = `
            <div style="min-width:220px;font-family:ui-monospace, Menlo;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                <div style="width:34px;height:34px;border-radius:8px;overflow:hidden;border:1px solid #25304a">
                  <img src="${j.cover_img}" style="width:34px;height:34px;object-fit:cover">
                </div>
                <div>
                  <div style="font-weight:700">${j.title}</div>
                  <div style="color:#9aa3b2;font-size:12px">by ${j.author_name} ‚Ä¢ ${j.date_range}</div>
                </div>
              </div>
              <div style="margin:6px 0 8px 0">${w.name ? `<strong>${w.name}</strong>` : ""} <span style="color:#9aa3b2">${w.note_time||""}</span></div>
              ${w.photo ? `<img src="${w.photo}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid #25304a">` : ""}
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <div style="color:#9aa3b2;font-size:12px">${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?"day":"days"}</div>
                <button data-like-popup="${j.id}" style="cursor:pointer;background:#0b0f16;border:1px solid #2a2f45;color:#fff;border-radius:10px;padding:6px 8px">
                  ${j.liked_by_me ? "‚ù§Ô∏è" : "ü§ç"} ${j.like_count||0}
                </button>
              </div>
            </div>`;
          m.bindPopup(html);
          m.on("popupopen", bindPopupLikeButton); // wire like in popup
          markers.push(m); m.addTo(g);
        });
      });
      let line=null;
      if(latlngs.length>1){
        line = L.polyline(latlngs, { color, weight:3, opacity:.9 });
        line.addTo(g);
        line.on("click", ()=> { focusJourney(j.id); });
      }
      return { layer:g, markers, line, visible:true, color };
    }

    function fitAllVisible(){
      const bounds = [];
      layersById.forEach(obj=>{
        if(!obj.visible) return;
        obj.markers.forEach(m=> bounds.push(m.getLatLng()));
      });
      if(!bounds.length) return;
      const b = L.latLngBounds(bounds);
      map.fitBounds(b, { padding:[40,40] });
    }

    function focusJourney(id){
      const obj = layersById.get(id); if(!obj) return;
      const pts = obj.markers.map(m=>m.getLatLng());
      if(!pts.length) return;
      map.fitBounds(L.latLngBounds(pts), { padding:[40,40] });
      // also blink the polyline if present
      if(obj.line){
        const old = obj.line.options.weight;
        obj.line.setStyle({ weight:6 });
        setTimeout(()=> obj.line.setStyle({ weight:old }), 600);
      }
      highlightListItem(id);
    }

    function setVisible(id, visible){
      const obj = layersById.get(id); if(!obj) return;
      obj.visible = visible;
      if(visible){ obj.layer.addTo(map); } else { obj.layer.remove(); }
      updateItemVisibilityChip(id, visible);
    }

    // ---------- sidebar rendering ----------
    function itemHTML(j, color){
      const likeIcon = j.liked_by_me ? "‚ù§Ô∏è" : "ü§ç";
      const pts = `${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?"day":"days"}`;
      return `
        <div class="item" id="item_${j.id}">
          <div class="meta">
            <div>
              <div class="title">${j.title}</div>
              <div class="subtitle">by ${j.author_name} ‚Ä¢ ${j.date_range}</div>
            </div>
            <span class="chip"><span class="dot" style="background:${color}"></span>${pts}</span>
          </div>

          <div class="row">
            <button class="btn small" data-focus="${j.id}">Focus</button>
            <button class="btn small" data-toggle="${j.id}">Hide</button>
            <button class="heart ${j.liked_by_me?"liked":""}" data-like="${j.id}">
              <span class="likeIcon">${likeIcon}</span>
              <span class="likeCount">${j.like_count||0}</span>
            </button>
          </div>

          <div class="gallery">
            ${((j.days?.[0]?.waypoints)||[]).slice(0,4).map(w=>`<img class="thumb" src="${w.photo}" alt="${w.name}">`).join("") || `<div class="subtitle">no photos</div>`}
          </div>
        </div>`;
    }

    function renderList(){
      const html = feed.map((j,i)=> itemHTML(j, layersById.get(j.id)?.color || palette[i%palette.length])).join("");
      $("#list").innerHTML = html;

      // bind buttons
      $$("#list [data-focus]").forEach(btn=>{
        btn.addEventListener("click", ()=> focusJourney(btn.getAttribute("data-focus")));
      });
      $$("#list [data-toggle]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-toggle");
          const obj = layersById.get(id);
          const next = !obj.visible;
          setVisible(id, next);
        });
      });
      $$("#list [data-like]").forEach(btn=>{
        btn.addEventListener("click", ()=> likeJourney(btn.getAttribute("data-like")));
      });
    }

    function updateItemVisibilityChip(id, visible){
      const el = $(`#item_${id} [data-toggle="${id}"]`);
      if(el) el.textContent = visible ? "Hide" : "Show";
    }
    function highlightListItem(id){
      $$("#list .item").forEach(x=> x.style.outline = "");
      const it = $(`#item_${id}`);
      if(it){ it.style.outline = "1px solid #1f8b8b"; it.scrollIntoView({block:"nearest"}); setTimeout(()=> it.style.outline="", 900); }
    }
    function reflectLikeUI(id, liked, count){
      // sidebar
      const item = $(`#item_${id}`);
      if(item){
        item.querySelector(".likeIcon").textContent = liked ? "‚ù§Ô∏è" : "ü§ç";
        item.querySelector(".likeCount").textContent = count;
        item.querySelector("[data-like]").classList.toggle("liked", liked);
      }
      // any open popup button
      const btn = document.querySelector(`button[data-like-popup="${id}"]`);
      if(btn){ btn.innerHTML = `${liked ? "‚ù§Ô∏è" : "ü§ç"} ${count}`; }
    }

    // ---------- likes ----------
    async function likeJourney(id){
      const j = feed.find(x=>x.id===id); if(!j) return;
      const want = !j.liked_by_me;
      try{
        const r = await jfetch("/api/like",{ method:"POST", body: JSON.stringify({ post_id:id, action: want?"like":"unlike" }) });
        j.liked_by_me = r.liked_by_me; j.like_count = r.like_count;
        setGlobalLikes(r.global_like_count);
        reflectLikeUI(id, r.liked_by_me, r.like_count);
        say(want?"Liked":"Unliked");
      }catch{ say("Like failed"); }
    }
    function bindPopupLikeButton(e){
      const id = [...e.popup._source.getPopup().getContent().matchAll(/data-like-popup="([^"]+)"/g)].map(m=>m[1])[0];
      const btn = document.querySelector(`button[data-like-popup="${id}"]`);
      if(btn){
        btn.addEventListener("click", async (ev)=>{
          ev.stopPropagation();
          await likeJourney(id);
        }, { once:false });
      }
    }

    // ---------- login ----------
    async function doLogin(){
      const username = $("#u").value.trim().toLowerCase();
      const password = $("#p").value;
      $("#loginFlash").textContent = "";
      try{
        await jfetch("/api/login",{method:"POST",body:JSON.stringify({username,password})});
        $("#login").style.display="none";
        await boot();
      }catch(err){
        let message = "Invalid credentials.";
        try{ const j = JSON.parse(err.message); if(j && j.error) message = j.error; }catch(e){ if(err && err.message) message = err.message; }
        $("#loginFlash").textContent = message;
      }
    }
    $("#loginBtn").addEventListener("click", doLogin);
    $("#logoutBtn").addEventListener("click", async ()=>{ try{ await jfetch("/api/logout",{method:"POST"}); location.reload(); }catch{} });

    // ---------- boot ----------
    async function boot(){
      const who = await jfetch("/api/whoami").catch(()=>null);
      if(!who){
        $("#login").style.display="grid";
        $("#who").textContent = "";
        setGlobalLikes(null);
        return;
      }
      $("#login").style.display="none";
      $("#who").textContent = who.name || who.username || "";

      // map init
      if(!map){
        map = L.map("map", { scrollWheelZoom:true, zoomControl:true }).setView([20,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
      }

      // load feed (visible journeys only)
      const data = await jfetch("/api/feed");
      feed = data.items || [];
      setGlobalLikes(data.global_like_count);

      // clear previous layers
      layersById.forEach(obj=> obj.layer.remove());
      layersById.clear();

      // build layers + list
      const pointsAll = [];
      feed.forEach((j,i)=>{
        const color = palette[i % palette.length];
        const obj = buildJourneyLayer(j, color);
        obj.layer.addTo(map);
        layersById.set(j.id, obj);
        obj.markers.forEach(m=> pointsAll.push(m.getLatLng()));
      });

      renderList();

      // initial fit
      if(pointsAll.length){
        map.fitBounds(L.latLngBounds(pointsAll), { padding:[40,40] });
      }
    }

    // top buttons
    $("#btnShowAll").addEventListener("click", ()=>{
      layersById.forEach((_,id)=> setVisible(id,true));
      fitAllVisible();
    });
    $("#btnHideAll").addEventListener("click", ()=>{
      layersById.forEach((_,id)=> setVisible(id,false));
    });
    $("#btnFitAll").addEventListener("click", fitAllVisible);

    // start
    (async ()=> {
      const who = await jfetch("/api/whoami").catch(()=>null);
      if(!who){ $("#login").style.display="grid"; } else { $("#who").textContent = who.name || who.username || ""; }
      if(who){ boot(); }
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tripline — CLI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Leaflet for maps in the detail pane -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    :root { --bg:#0b0c10; --panel:#0f1420; --text:#e8e8e8; --muted:#9aa3b2; --acc:#6ee7b7; --border:#202335; --em:#1f8b8b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* ---------- Login ---------- */
    #loginView{display:none; height:100vh; display:grid; place-items:center;}
    .login-box{width:min(520px,92vw); background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .login-box h1{margin:0 0 10px 0; font-size:18px}
    .login-row{display:grid; grid-template-columns:100px 1fr; gap:10px; margin:8px 0}
    .login-input{background:#0a0e17; border:1px solid #25304a; border-radius:8px; padding:10px 12px; color:#e8e8e8}
    .login-help{color:var(--muted); font-size:12px; margin-top:6px}
    .btn{display:inline-block; padding:10px 14px; border-radius:8px; border:1px solid #2a2f45; background:#1b2133; color:#fff; cursor:pointer}

    /* ---------- Full-screen CLI ---------- */
    #cliView{display:none; height:100vh; display:grid; grid-template-rows:48px 1fr 34px}
    .cli-top{display:flex; align-items:center; gap:10px; padding:8px 12px; border-bottom:1px solid var(--border); background:#0b0f16; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .tag{border:1px solid var(--border); background:#0b0f16; padding:4px 8px; border-radius:8px; color:var(--muted); font-size:12px}
    .pill{border:1px solid var(--border); background:#0b0f16; padding:4px 8px; border-radius:999px; color:#cbd5e1; font-size:12px}
    .user{color:var(--acc)}
    .search{flex:1; display:flex; gap:8px; align-items:center}
    .search input{flex:1; background:#0a0e17; border:1px solid #25304a; border-radius:8px; padding:8px 10px; color:#e8e8e8; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .cli-main{display:grid; grid-template-columns:1.1fr 1.4fr; min-height:0}
    .list{border-right:1px solid var(--border); min-height:0; overflow:auto; background:#0b0f16}
    .row{display:grid; grid-template-columns:90px 88px 1fr 140px; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px dashed #1e2233; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .row .id{color:var(--acc)}
    .row .likes{min-width:78px}
    .row .title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .row .author{text-align:right; color:var(--muted)}
    .row[aria-selected="true"]{background:linear-gradient(90deg,#0d1626,#0f2233); outline:1px solid var(--em)}
    .empty{padding:16px; color:var(--muted); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .detail{min-height:0; overflow:auto; background:#0f1420; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .detail-pad{padding:12px; display:grid; gap:10px}
    .detail h2{font-size:16px; margin:0}
    .muted{color:var(--muted)}
    .sub{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .dot{width:6px; height:6px; border-radius:50%; background:#2a2f45; display:inline-block}
    .gallery{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
    .thumb{width:100%; height:88px; object-fit:cover; border-radius:8px; border:1px solid #25304a}
    .cover{width:100%; height:150px; object-fit:cover; border-radius:8px; border:1px solid #25304a}
    .map{width:100%; height:220px; border-radius:8px; border:1px solid #25304a; overflow:hidden}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kbd{border:1px solid #2a2f45; background:#0b0f16; padding:2px 6px; border-radius:6px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .cli-bottom{display:flex; gap:12px; align-items:center; padding:8px 12px; border-top:1px solid var(--border); background:#0b0f16; color:var(--muted); font-size:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .error{color:#ffb4b4}
    .success{color:#a7f3d0}
  </style>
</head>
<body>

  <!-- Login -->
  <section id="loginView">
    <div class="login-box">
      <h1>Tripline — Login</h1>
      <div class="login-row">
        <label>username</label>
        <input class="login-input" id="u" placeholder="alice / bob / charlie" autofocus>
      </div>
      <div class="login-row">
        <label>password</label>
        <input class="login-input" id="p" type="password" placeholder="pass">
      </div>
      <div class="login-row" style="grid-template-columns:100px auto;">
        <span></span>
        <button class="btn" id="loginBtn">Sign in (↵)</button>
      </div>
      <div class="login-help">Use demo accounts: <code>alice / pass</code>, <code>bob / pass</code>, <code>charlie / pass</code></div>
      <div id="loginFlash" class="login-help"></div>
    </div>
  </section>

  <!-- Full-screen CLI -->
  <section id="cliView" aria-label="Feed CLI">
    <header class="cli-top">
      <span class="tag">FEED</span>
      <div class="search">
        <input id="q" placeholder="Type to filter • j/k or ↑/↓ to move • Enter open • l like • ←/→ day • Esc back">
      </div>
      <span class="pill" id="globalLikes" style="display:none"></span>
      <span class="pill">signed in: <span id="who" class="user"></span></span>
      <button class="btn" id="logoutBtn">Log out</button>
    </header>

    <main class="cli-main">
      <div class="list" id="list" role="listbox" aria-activedescendant=""></div>
      <aside class="detail" id="detail">
        <div class="detail-pad" id="detailPad">
          <h2>Details</h2>
          <div class="muted">Select a post and press <span class="kbd">Enter</span>.</div>
        </div>
      </aside>
    </main>

    <footer class="cli-bottom">
      <span><span class="kbd">/</span> focus search</span>
      <span><span class="kbd">j</span>/<span class="kbd">k</span> or <span class="kbd">↑</span>/<span class="kbd">↓</span> move</span>
      <span><span class="kbd">Enter</span> open</span>
      <span><span class="kbd">l</span> like/unlike</span>
      <span><span class="kbd">←</span>/<span class="kbd">→</span> switch day</span>
      <span><span class="kbd">Esc</span> clear/back</span>
    </footer>
  </section>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // ---------- tiny helpers ----------
    const $ = (sel, root=document)=> root.querySelector(sel);
    async function jfetch(url, opts={}) {
      const res = await fetch(url, { credentials:"include", headers:{ "Content-Type":"application/json" }, ...opts });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function setGlobalLikesBadge(n){
      const el = $("#globalLikes");
      if(typeof n === "number"){ el.style.display="inline-block"; el.textContent = `total likes: ${n}`; }
      else { el.style.display="none"; }
    }
    function toast(msg, isErr=false){
      const hdr = $(".cli-top");
      const span = document.createElement("span");
      span.style.marginLeft = "8px";
      span.className = isErr ? "error" : "success";
      span.textContent = `• ${msg}`;
      hdr.appendChild(span);
      setTimeout(()=> span.remove(), 2000);
    }

    // ---------- state ----------
    let me = null;
    let feed = [];
    let filtered = [];
    let cursor = -1;
    let detailOpen = false;
    let detail = { post:null, dayIndex:0 }; // currently opened post + day

    // ---------- login wiring ----------
    async function tryLogin() {
      const username = $("#u").value.trim().toLowerCase();
      const password = $("#p").value;
      $("#loginFlash").textContent = "";
      try{
        await jfetch("/api/login",{method:"POST",body:JSON.stringify({username,password})});
        await boot();
      }catch(err){
        let message = "Invalid credentials.";
        try{ const j = JSON.parse(err.message); if(j && j.error) message = j.error; }catch(e){ if(err && err.message) message = err.message; }
        $("#loginFlash").innerHTML = `<span class="error">${message}</span>`;
      }
    }
    $("#loginBtn").addEventListener("click", tryLogin);
    $("#p").addEventListener("keydown", e=>{ if(e.key==="Enter") tryLogin(); });
    $("#u").addEventListener("keydown", e=>{ if(e.key==="Enter") tryLogin(); });

    // ---------- list rendering ----------
    function rowHTML(j){
      const heart = j.liked_by_me ? "♥" : "♡";
      const likes = `${heart} ${j.like_count||0}`;
      const title = j.title || "(untitled)";
      const author = j.author_name || j.author || "";
      const range = j.date_range || "";
      return `
        <div class="row" role="option" id="row_${j.id}" data-id="${j.id}" aria-selected="false">
          <div class="id">#${j.id}</div>
          <div class="likes">[${likes}]</div>
          <div class="title">${title} — <span class="muted">${range}</span></div>
          <div class="author">${author}</div>
        </div>`;
    }
    function renderList(){
      const el = $("#list");
      if(!filtered.length){
        el.innerHTML = `<div class="empty">no results</div>`;
        $("#list").setAttribute("aria-activedescendant","");
        return;
      }
      el.innerHTML = filtered.map(rowHTML).join("");
      $("#list").querySelectorAll(".row").forEach((r,i)=>{
        r.addEventListener("click", ()=>{ cursor = i; updateCursor(); });
        r.addEventListener("dblclick", ()=> openDetail());
      });
      cursor = Math.max(0, Math.min(cursor, filtered.length-1));
      updateCursor();
    }
    function updateCursor(){
      $("#list").querySelectorAll(".row").forEach((r,i)=>{
        r.setAttribute("aria-selected", String(i===cursor));
      });
      const active = $("#list").querySelector(`[aria-selected="true"]`);
      if(active){ $("#list").setAttribute("aria-activedescendant", active.id); active.scrollIntoView({block:"nearest"}); }
    }

    // ---------- detail rendering (visual: cover + map + gallery) ----------
    let leafletMap = null;
    function destroyMap(){
      if(leafletMap){ try{ leafletMap.remove(); }catch{} leafletMap = null; }
    }
    function initMap(container, waypoints){
      destroyMap();
      if(!container) return;
      const pts = waypoints || [];
      const center = pts.length ? [pts[0].lat, pts[0].lng] : [0,0];
      leafletMap = L.map(container,{scrollWheelZoom:false, zoomControl:true}).setView(center, pts.length?14:1);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(leafletMap);
      const latlngs=[];
      pts.forEach(w=>{
        const m = L.marker([w.lat,w.lng]).addTo(leafletMap);
        const html = `<div class="mono"><strong>${w.name}</strong><br/><span class="muted">${w.note_time||""}</span><br/>${w.comment||""}</div>`;
        m.bindPopup(html);
        latlngs.push([w.lat,w.lng]);
      });
      if(latlngs.length>1){ L.polyline(latlngs,{weight:3}).addTo(leafletMap); leafletMap.fitBounds(latlngs,{padding:[20,20]}); }
      setTimeout(()=>leafletMap.invalidateSize(), 50);
    }

    function renderDetailView(full, dayIndex=0){
      const pad = $("#detailPad");
      if(!full){
        pad.innerHTML = `<h2>Details</h2><div class="muted">Select a post and press <span class="kbd">Enter</span>.</div>`;
        destroyMap();
        return;
      }
      const N = (full.days||[]).length;
      const i = Math.max(0, Math.min(dayIndex, Math.max(0, N-1)));
      const day = (full.days||[])[i] || { title:"", date:"", waypoints:[] };

      pad.innerHTML = `
        <div>
          <h2>${full.title}</h2>
          <div class="sub">
            <span class="muted">by ${full.author_name || full.author}</span>
            <span class="dot"></span>
            <span class="muted">${full.date_range}</span>
            <span class="dot"></span>
            <span class="muted">likes: ${full.like_count} ${full.liked_by_me ? "• you like this" : ""}</span>
          </div>
        </div>

        <img class="cover" src="${full.cover_img}" alt="${full.title} cover">

        <div class="toolbar">
          <span class="muted">day ${i+1}/${N || 1}</span>
          <span class="dot"></span>
          <strong class="mono">${day.title || "Day"}</strong>
          <span class="muted">• ${day.date || ""}</span>
          <span class="dot"></span>
          <span class="muted">keys: <span class="kbd">←</span>/<span class="kbd">→</span> day • <span class="kbd">l</span> like • <span class="kbd">Esc</span> close</span>
        </div>

        <div id="detailMap" class="map" aria-label="Journey map"></div>

        <div>
          <div class="muted" style="margin-bottom:6px">photos</div>
          <div class="gallery">
            ${(day.waypoints||[]).map(w=>`<img class="thumb" src="${w.photo}" alt="${w.name}">`).join("") || `<div class="muted">no photos</div>`}
          </div>
        </div>

        <div>
          <div class="muted" style="margin:8px 0 6px">itinerary</div>
          <pre class="mono" style="white-space:pre-wrap">${(day.waypoints||[]).map(w=>`- ${w.note_time||""} ${w.name}${w.comment?": "+w.comment:""}`).join("\n") || "no waypoints"}</pre>
        </div>
      `;

      // build map for the chosen day
      initMap($("#detailMap"), day.waypoints||[]);
    }

    // ---------- CLI actions ----------
    function filterList(q){
      const s = (q||"").trim().toLowerCase();
      if(!s){ filtered = feed.slice(); }
      else {
        filtered = feed.filter(j=>{
          const hay = (j.title+" "+j.author_name+" "+j.author+" "+(j.date_range||"")).toLowerCase();
          return hay.includes(s);
        });
      }
      renderList();
    }
    function move(delta){
      if(!filtered.length) return;
      cursor = (cursor + delta + filtered.length) % filtered.length;
      updateCursor();
    }
    async function toggleLikeSelected(){
      if(cursor<0 || !filtered[cursor]) return;
      const j = filtered[cursor];
      const liked = !!j.liked_by_me;
      try{
        const r = await jfetch("/api/like",{method:"POST",body:JSON.stringify({post_id:j.id, action: liked?"unlike":"like"})});
        const apply = it => { if(it && it.id===j.id){ it.liked_by_me = r.liked_by_me; it.like_count = r.like_count; } };
        feed.forEach(apply); filtered.forEach(apply);
        const row = $("#row_"+j.id);
        if(row){ row.querySelector(".likes").textContent = `[${r.liked_by_me?"♥":"♡"} ${r.like_count}]`; }
        setGlobalLikesBadge(r.global_like_count);

        if(detailOpen && detail.post && detail.post.id === j.id){
          // re-fetch to ensure counts are fresh
          const fresh = await jfetch(`/api/journey?id=${encodeURIComponent(j.id)}`);
          detail.post = fresh;
          renderDetailView(detail.post, detail.dayIndex);
        }
      }catch(e){
        console.error(e);
        toast("Like failed.", true);
      }
    }
    async function openDetail(){
      if(cursor<0 || !filtered[cursor]) return;
      const j = filtered[cursor];
      try{
        const full = await jfetch(`/api/journey?id=${encodeURIComponent(j.id)}`);
        detail.post = full;
        detail.dayIndex = 0;
        renderDetailView(detail.post, detail.dayIndex);
        detailOpen = true;
      }catch(e){
        renderDetailView(null);
        toast("Failed to load details.", true);
      }
    }
    function closeDetail(){
      detailOpen = false;
      detail.post = null;
      detail.dayIndex = 0;
      destroyMap();
      renderDetailView(null);
    }
    function switchDay(delta){
      if(!detailOpen || !detail.post) return;
      const N = (detail.post.days||[]).length || 1;
      detail.dayIndex = ((detail.dayIndex + delta) % N + N) % N;
      renderDetailView(detail.post, detail.dayIndex);
    }

    // ---------- global keys ----------
    function onKey(e){
      const q = $("#q");
      const typingInSearch = document.activeElement === q;

      if(e.key==="/" && !typingInSearch){ e.preventDefault(); q.focus(); q.select(); return; }
      if(e.key==="Escape"){
        if(typingInSearch){ q.value=""; filterList(""); q.blur(); return; }
        if(detailOpen){ closeDetail(); return; }
        q.value=""; filterList(""); return;
      }
      if(e.key==="Enter"){ e.preventDefault(); openDetail(); return; }
      if(e.key.toLowerCase()==="l"){ e.preventDefault(); toggleLikeSelected(); return; }
      if(e.key==="ArrowDown" || e.key.toLowerCase()==="j"){ e.preventDefault(); move(+1); return; }
      if(e.key==="ArrowUp" || e.key.toLowerCase()==="k"){ e.preventDefault(); move(-1); return; }
      if(e.key==="ArrowLeft"){ e.preventDefault(); switchDay(-1); return; }
      if(e.key==="ArrowRight"){ e.preventDefault(); switchDay(+1); return; }

      const printable = e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey;
      if(!typingInSearch && printable){ q.focus(); }
    }
    window.addEventListener("keydown", onKey);
    $("#q").addEventListener("input", (e)=> filterList(e.target.value));
    $("#logoutBtn").addEventListener("click", async ()=>{
      try{ await jfetch("/api/logout",{method:"POST"}); location.reload(); }catch{}
    });

    // ---------- boot ----------
    async function boot(){
      me = await jfetch("/api/whoami").catch(()=>null);
      if(!me){
        $("#loginView").style.display = "grid";
        $("#cliView").style.display = "none";
        $("#u").focus();
        return;
      }
      $("#loginView").style.display = "none";
      $("#cliView").style.display = "grid";
      $("#who").textContent = me?.name || me?.username || "";

      const data = await jfetch("/api/feed");
      feed = data.items || [];
      setGlobalLikesBadge(data.global_like_count);
      filterList($("#q").value || "");
      $("#q").focus();
    }

    boot();
  </script>
</body>
</html>

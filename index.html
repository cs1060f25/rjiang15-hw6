<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tripline ‚Äî MVP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    :root { --bg:#0b0c10; --card:#151720; --text:#e8e8e8; --muted:#9aa3b2; --brand:#6ee7b7; --danger:#ff6b6b; --warn:#f7b733; --border:#202335; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:16px} .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:#222637;color:#fff;border:1px solid #2a2f45;cursor:pointer}
    .btn.brand{background:linear-gradient(135deg,#22c55e,#06b6d4);border:0}.btn.ghost{background:transparent;border:1px solid #2a2f45}
    .muted{color:var(--muted);font-size:14px}.flash{padding:12px 14px;border-radius:10px;margin-bottom:10px}.flash.success{background:#1f3d2a;color:#a7f3d0}
    .flash.error{background:#3d1f1f;color:#fecaca}.pill{padding:6px 10px;border-radius:999px;background:#0f111a;border:1px solid #2a2f45;font-size:12px;color:#cbd5e1}
    header{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:12px} nav a{margin-right:16px;color:var(--brand);text-decoration:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px}.content{padding:16px}
    .feed-cover{width:100%;height:220px;object-fit:cover}.carousel{position:relative;overflow:hidden;background:#0f111a;border-top:1px solid var(--border)}
    .carousel-track{display:flex;transition:transform .3s ease}.slide{min-width:100%}.slide-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .map{width:100%;height:280px;background:#0f111a}.map.large{height:480px}.nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(17,17,17,.6);border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    .nav-btn.left{left:8px}.nav-btn.right{right:8px}.dots{display:flex;gap:6px;align-items:center;justify-content:center;padding:10px 0}.dot{width:7px;height:7px;border-radius:50%;background:#2a2f45}.dot.active{background:#6ee7b7}
    .journey-meta{display:flex;align-items:center;justify-content:space-between;gap:10px}.waypoint{display:grid;grid-template-columns:180px 1fr;gap:14px;padding:12px;border-top:1px solid var(--border)}
    .waypoint img{width:100%;height:120px;object-fit:cover;border-radius:10px} footer{opacity:.7;font-size:13px;text-align:center;margin-top:16px}
    .toolbar{display:flex;gap:10px;align-items:center}
    .heart{cursor:pointer;border:1px solid var(--border);background:#0f111a;border-radius:10px;padding:8px 10px;display:inline-flex;align-items:center;gap:8px}
    .heart.liked{border-color:#2e7d32;background:#112315}
    .heart [data-like-count] { color: #fff !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="toolbar">
        <strong>Tripline</strong>
        <nav id="nav" style="margin-left:12px; display:none;">
          <a href="/feed" data-link>Feed</a>
          <a href="/account" data-link>Account</a>
        </nav>
      </div>
      <div class="toolbar">
        <span id="globalLikes" class="pill" style="display:none"></span>
        <div id="authArea"></div>
      </div>
    </header>

    <div id="flash"></div>

    <!-- PAGES -->
    <div id="page-login" style="display:none;">
      <div class="card" style="max-width:420px;margin:48px auto;">
        <div class="content">
          <h1 style="margin:0 0 8px 0;">Welcome back</h1>
          <p class="muted">Demo accounts: <code>alice / pass</code>, <code>bob / pass</code>, <code>charlie / pass</code></p>
          <form id="loginForm" style="display:grid; gap:10px; margin-top:16px;">
            <input name="username" placeholder="Username (e.g., alice)" required style="padding:12px;border-radius:10px;border:1px solid #2a2f45;background:#0f111a;color:#fff;">
            <input name="password" type="password" placeholder="Password" required style="padding:12px;border-radius:10px;border:1px solid #2a2f45;background:#0f111a;color:#fff;">
            <button class="btn brand" type="submit">Sign in</button>
          </form>
        </div>
      </div>
    </div>

    <div id="page-feed" style="display:none;"></div>
    <div id="page-journey" style="display:none;"></div>
    <div id="page-account" style="display:none;"></div>

    <footer>Prototype ‚Ä¢ Maps powered by OpenStreetMap via Leaflet</footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ---------- tiny client router ----------
    function $(sel, root=document){ return root.querySelector(sel); }
    function show(id){ ["page-login","page-feed","page-journey","page-account"].forEach(p=>$("#"+p).style.display = p===id ? "" : "none"); }
    function flash(type,msg){ $("#flash").innerHTML = msg ? `<div class="flash ${type}">${msg}</div>` : ""; }
    function navigate(path){ history.pushState({}, "", path); render(); }
    window.addEventListener("popstate", render);
    document.addEventListener("click", (e) => {
      const a = e.target.closest("[data-link]");
      if (a){ e.preventDefault(); navigate(a.getAttribute("href")); }
    });

    // ---------- helpers ----------
    async function jfetch(url, opts={}){
      const res = await fetch(url, {credentials:"include", headers:{ "Content-Type":"application/json" }, ...opts});
      if(!res.ok){ throw new Error(await res.text()); }
      return res.json();
    }
    function setAuthUI(user){
      const nav = $("#nav"); const auth = $("#authArea");
      if(user){
        nav.style.display = ""; auth.innerHTML = `<span class="muted" style="margin-right:8px;">Signed in as ${user.name}</span>
          <button class="btn ghost" id="logoutBtn">Log out</button>`;
        $("#logoutBtn").onclick = async ()=>{ await jfetch("/api/logout",{method:"POST"}); navigate("/login"); };
      } else {
        nav.style.display = "none"; auth.innerHTML = "";
      }
    }
    function setGlobalLikesBadge(n){
      const el = $("#globalLikes");
      if(!el) return;
      if(typeof n === "number"){ el.style.display="inline-block"; el.textContent = `Total likes: ${n}`; }
      else { el.style.display="none"; }
    }

    // ---------- renderers ----------
    function likeButtonHTML(j){
      const liked = !!j.liked_by_me;
      const count = j.like_count || 0;
      const label = liked ? "Unlike" : "Like";
      return `
        <button class="heart ${liked?"liked":""}" data-like data-post="${j.id}" aria-pressed="${liked}">
          <span>${liked ? "‚ù§Ô∏è" : "ü§ç"}</span>
          <span data-like-count>${count}</span>
          <span class="muted" style="font-size:12px">${label}</span>
        </button>`;
    }

    function renderFeed(items, globalLikeCount){
      setGlobalLikesBadge(globalLikeCount);
      const root = $("#page-feed"); root.innerHTML = `<h2 style="margin:8px 0 12px 0;">Today‚Äôs Feed</h2>`;
      items.forEach(j=>{
        const id = `feed_${j.id}`;
        root.insertAdjacentHTML("beforeend", `
          <article class="card" data-journey-id="${j.id}">
            <img class="feed-cover" src="${j.cover_img}" alt="${j.title}">
            <div class="content">
              <div class="journey-meta">
                <div>
                  <strong style="display:block;">${j.title}</strong>
                  <span class="muted">by ${j.author_name} ‚Ä¢ ${j.date_range}</span>
                </div>
                <span class="pill">${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?"day":"days"}</span>
              </div>
              <p style="margin:10px 0 14px 0;">${j.summary}</p>
              <div class="carousel" data-carousel>
                <div class="carousel-track">
                  ${j.days.map((d,idx)=>`
                    <section class="slide">
                      <div class="slide-header">
                        <div><strong>${d.title}</strong> <span class="muted">‚Ä¢ ${d.date}</span></div>
                        <span class="pill">Stops ${d.waypoints.length}</span>
                      </div>
                      <div id="${id}_${idx}" class="map" data-waypoints='${JSON.stringify(d.waypoints)}'></div>
                    </section>`).join("")}
                </div>
                <button class="nav-btn left" data-prev aria-label="Previous">‚Äπ</button>
                <button class="nav-btn right" data-next aria-label="Next">‚Ä∫</button>
                <div class="dots">${j.days.map((_,i)=>`<span class="dot ${i===0?"active":""}"></span>`).join("")}</div>
              </div>
              <div class="content" style="padding-left:0;padding-right:0;">
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center;">
                  ${likeButtonHTML(j)}
                  <a class="btn brand" href="/journey/${j.id}" data-link>View Journey</a>
                </div>
              </div>
            </div>
          </article>
        `);
      });
      setupAllCarousels();
      wireLikeButtons();
    }

    function renderJourney(j){
      const root = $("#page-journey");
      root.innerHTML = `
        <article class="card">
          <img class="feed-cover" style="height:260px" src="${j.cover_img}" alt="${j.title}">
          <div class="content">
            <div class="journey-meta">
              <div>
                <h2 style="margin:0">${j.title}</h2>
                <span class="muted">by ${j.author_name} ‚Ä¢ ${j.date_range}</span>
              </div>
              <span class="pill">${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?"day":"days"}</span>
            </div>
            <p style="margin:12px 0 16px 0;">${j.summary}</p>

            <div class="carousel" data-carousel>
              <div class="carousel-track">
                ${j.days.map((d,idx)=>`
                <section class="slide">
                  <div class="slide-header">
                    <div><strong>${d.title}</strong> <span class="muted">‚Ä¢ ${d.date}</span></div>
                    <span class="pill">Stops ${d.waypoints.length}</span>
                  </div>
                  <div class="map large" id="journey_${j.id}_${idx}" data-waypoints='${JSON.stringify(d.waypoints)}'></div>
                  ${d.waypoints.map(w=>`
                    <div class="waypoint">
                      <img src="${w.photo}" alt="${w.name}">
                      <div>
                        <strong>${w.name}</strong> <span class="muted">‚Ä¢ ${w.note_time||""}</span>
                        <p style="margin:6px 0 0 0;">${w.comment||""}</p>
                      </div>
                    </div>`).join("")}
                </section>`).join("")}
              </div>
              <button class="nav-btn left" data-prev aria-label="Previous">‚Äπ</button>
              <button class="nav-btn right" data-next aria-label="Next">‚Ä∫</button>
              <div class="dots">${j.days.map((_,i)=>`<span class="dot ${i===0?"active":""}"></span>`).join("")}</div>
            </div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; align-items:center;">
              ${likeButtonHTML(j)}
              <button class="btn ghost" onclick="alert('Share not in MVP')">Share</button>
            </div>
          </div>
        </article>
        <p style="margin-top:14px;"><a href="/feed" data-link>‚Üê Back to Feed</a></p>`;
      setupAllCarousels();
      wireLikeButtons();
    }

    function renderAccount(data){
      setGlobalLikesBadge(data.global_like_count);
      const root = $("#page-account");
      const sections = Object.entries(data.folders).map(([folder, journeys])=>`
        <section class="card" style="padding:12px;">
          <h3>${folder}</h3>
          <div class="content" style="padding:0">
            ${journeys.map(j=>`
              <article class="card" style="overflow:hidden;">
                <img class="feed-cover" style="height:120px" src="${j.cover_img}" alt="${j.title}">
                <div class="content">
                  <strong style="display:block; margin-bottom:6px;">${j.title}</strong>
                  <span class="muted">${j.date_range} ‚Ä¢ ${j.total_waypoints} pts ‚Ä¢ ${j.days.length} ${j.days.length===1?"day":"days"}</span>
                  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center;">
                    ${likeButtonHTML(j)}
                    <a class="btn brand" href="/journey/${j.id}" data-link>Open</a>
                  </div>
                </div>
              </article>`).join("")}
          </div>
        </section>`).join("");
      root.innerHTML = `<h2>Your Account</h2><p class="muted">Journeys organized by folders.</p>${sections}`;
      wireLikeButtons();
    }

    // ---------- carousel + maps ----------
    function setupCarousel(root){
      const track = root.querySelector('.carousel-track');
      const slides = [...root.querySelectorAll('.slide')];
      const dots = [...root.querySelectorAll('.dot')];
      const prevBtn = root.querySelector('[data-prev]'); const nextBtn = root.querySelector('[data-next]');
      let index = 0, startX = 0, deltaX = 0;
      function initMapFor(i){
        const mapDiv = slides[i].querySelector('.map');
        if(mapDiv && !mapDiv.dataset.initialized){
          const pts = JSON.parse(mapDiv.dataset.waypoints||"[]");
          const center = pts.length?[pts[0].lat,pts[0].lng]:[0,0];
          const map = L.map(mapDiv,{scrollWheelZoom:false}).setView(center, pts.length?14:1);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
          const latlngs=[]; pts.forEach(w=>{ L.marker([w.lat,w.lng]).addTo(map).bindPopup(`<strong>${w.name}</strong><br/><em>${w.note_time||''}</em><br/><img src="${w.photo}" style="width:160px;height:100px;object-fit:cover;margin-top:6px;border-radius:6px;" /><br/><span style="font-size:12px;color:#94a3b8">${w.comment||''}</span>`); latlngs.push([w.lat,w.lng]); });
          if(latlngs.length>1){ L.polyline(latlngs,{weight:3}).addTo(map); map.fitBounds(latlngs,{padding:[20,20]}); }
          mapDiv.dataset.initialized="1"; setTimeout(()=>map.invalidateSize(),50);
        }
      }
      function update(){ track.style.transform = `translateX(-${index*100}%)`; dots.forEach((d,i)=>d.classList.toggle('active',i===index)); initMapFor(index);}
      prevBtn?.addEventListener('click',()=>{ index=Math.max(0,index-1); update();});
      nextBtn?.addEventListener('click',()=>{ index=Math.min(slides.length-1,index+1); update();});
      track.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;deltaX=0},{passive:true});
      track.addEventListener('touchmove',e=>{deltaX=e.touches[0].clientX-startX},{passive:true});
      track.addEventListener('touchend',()=>{ if(Math.abs(deltaX)>40){ if(deltaX<0&&index<slides.length-1)index++; if(deltaX>0&&index>0)index--; } update();});
      update();
    }
    function setupAllCarousels(){ document.querySelectorAll('[data-carousel]').forEach(setupCarousel); }

    // ---------- Like wiring ----------
    function wireLikeButtons(){
      document.querySelectorAll("[data-like]").forEach(btn=>{
        if(btn.dataset.bound) return;
        btn.dataset.bound = "1";
        btn.addEventListener("click", async ()=>{
          const post = btn.getAttribute("data-post");
          const liked = btn.classList.contains("liked");
          // optimistic flip
          btn.classList.toggle("liked", !liked);
          btn.setAttribute("aria-pressed", String(!liked));
          btn.querySelector("span").textContent = !liked ? "‚ù§Ô∏è" : "ü§ç";
          const countEl = btn.querySelector("[data-like-count]");
          const optimistic = Math.max(0, (parseInt(countEl.textContent||"0",10) || 0) + (liked?-1:1));
          countEl.textContent = optimistic;

          try{
            const r = await jfetch("/api/like", { method:"POST", body: JSON.stringify({ post_id: post, action: liked ? "unlike" : "like" }) });
            // reconcile with server truth
            btn.classList.toggle("liked", !!r.liked_by_me);
            btn.setAttribute("aria-pressed", String(!!r.liked_by_me));
            btn.querySelector("span").textContent = r.liked_by_me ? "‚ù§Ô∏è" : "ü§ç";
            countEl.textContent = r.like_count;
            setGlobalLikesBadge(r.global_like_count);
          }catch(err){
            // revert on error
            btn.classList.toggle("liked", liked);
            btn.setAttribute("aria-pressed", String(liked));
            btn.querySelector("span").textContent = liked ? "‚ù§Ô∏è" : "ü§ç";
            countEl.textContent = Math.max(0, optimistic + (liked?1:-1));
            flash("error","Like failed.");
            console.error(err);
          }
        });
      });
    }

    // ---------- main render ----------
    async function render(){
      flash("", ""); // clear
      const path = location.pathname;
      try{
        const me = await jfetch("/api/whoami").catch(()=>null);
        setAuthUI(me);

        if(path === "/" || path === "/login"){
          show("page-login");
        } else if(path === "/feed"){
          if(!me) return navigate("/login");
          const data = await jfetch("/api/feed");
          $("#page-feed").innerHTML = ""; renderFeed(data.items, data.global_like_count); show("page-feed");
        } else if(path.startsWith("/journey/")){
          if(!me) return navigate("/login");
          const jid = path.split("/").pop();
          const j = await jfetch(`/api/journey?id=${encodeURIComponent(jid)}`);
          $("#page-journey").innerHTML = ""; renderJourney(j); show("page-journey");
        } else if(path === "/account"){
          if(!me) return navigate("/login");
          const data = await jfetch("/api/account");
          $("#page-account").innerHTML = ""; renderAccount(data); show("page-account");
        } else {
          navigate("/feed");
        }

      }catch(err){
        console.error(err);
        let message = "Something went wrong.";
        try{ const j = JSON.parse(err.message); if(j && j.error) message = j.error; }catch(e){ if(err && err.message) message = err.message; }
        flash("error", message);
      }
    }

    // login handler
    $("#loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const username = e.target.username.value.trim().toLowerCase();
      const password = e.target.password.value;
      try{
        await jfetch("/api/login",{method:"POST",body:JSON.stringify({username,password})});
        flash("success","Welcome!");
        navigate("/feed");
      }catch(err){
        console.error('login error:', err);
        let message = "Invalid credentials. Try 'alice' / 'pass', 'bob' / 'pass', or 'charlie' / 'pass'.";
        try{ const j = JSON.parse(err.message); if(j && j.error) message = j.error; }catch(e){ if(err && err.message) message = err.message; }
        flash("error", message);
      }
    });

    render();
  </script>
</body>
</html>
